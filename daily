#! /usr/bin/env bash
# TODO: Make tasks happen concurrently
# TODO: Save daily output into persistant log

# A script for running daily maintinence tasks.

# Ask for sudo privileges. Required for acts/tarsnap backup
# Don't want to ask for privs lazily, because this should be the sort of thing you
# can walk away from and expect it to be done when you come back.
if [[ $UID != 0 ]]; then # only ask if not already elevated.
  echo "This script requires sudo privileges for backup access."
  sudo echo "Thanks. Commencing dailies."
  # TODO: Should handle rejected sudo request gracefully.
fi

do_command() { # $1 is the command title, $2 is the command to be evaluated
  echo
  echo '---'
  echo "$1"
  eval $2
}

# Check host OS, set $HOST_OS
if [[ "$OSTYPE" == "darwin"* ]]; then
  do_command 'BREW' "brew update && brew upgrade && echo 'Update successful.'"
elif [[ "$OSTYPE" == "linux-gnu" ]]; then
  do_command 'APT-GET' "sudo apt-get update && sudo apt-get upgrade && echo 'Update successful'"
else
  echo
  echo '---'
  echo "UNABLE TO DETERMINE HOST OS. CANNOT UPDATE"
fi

do_command 'WEATHER' "curl http://wttr.in/Goleta"

do_command 'BACKUP' "sudo acts && echo 'Backup was successful!'"

do_command 'BUNDLE-AUDIT' "bundle-audit update"

do_command 'RUBYGEMS' "gem update --system"

do_command 'TMUX' "tmux list-sessions"
